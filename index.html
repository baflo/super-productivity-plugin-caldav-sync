<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CalDAV Sync Settings</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      padding: 24px;
      background: var(--theme-background, #f5f5f5);
      color: var(--theme-text, #333);
      line-height: 1.6;
    }

    h1 {
      font-size: 24px;
      margin-bottom: 24px;
      color: var(--theme-primary, #2196F3);
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      font-size: 14px;
      color: var(--theme-text, #333);
    }

    input[type="text"],
    input[type="password"],
    input[type="url"] {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--theme-border, #ddd);
      border-radius: 4px;
      font-size: 14px;
      background: var(--theme-input-background, #fff);
      color: var(--theme-text, #333);
      transition: border-color 0.2s;
    }

    input[type="text"]:focus,
    input[type="password"]:focus,
    input[type="url"]:focus {
      outline: none;
      border-color: var(--theme-primary, #2196F3);
    }

    input::placeholder {
      color: var(--theme-text-secondary, #999);
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .checkbox-group label {
      margin: 0;
      font-weight: normal;
      cursor: pointer;
    }

    .button-group {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    button:active {
      transform: translateY(0);
    }

    .btn-primary {
      background: #4CAF50;
      color: white;
    }

    .btn-primary:hover {
      background: #45a049;
    }

    .btn-secondary {
      background: #2196F3;
      color: white;
    }

    .btn-secondary:hover {
      background: #0b7dda;
    }

    .btn-tertiary {
      background: var(--theme-border, #ddd);
      color: var(--theme-text, #333);
    }

    .btn-tertiary:hover {
      background: var(--theme-border-dark, #ccc);
    }

    .status {
      margin-top: 16px;
      padding: 12px;
      border-radius: 4px;
      font-size: 14px;
      display: none;
    }

    .status.show {
      display: block;
    }

    .status.success {
      background: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #81c784;
    }

    .status.error {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #e57373;
    }

    .status.info {
      background: #e3f2fd;
      color: #1565c0;
      border: 1px solid #64b5f6;
    }

    .hint {
      font-size: 12px;
      color: var(--theme-text-secondary, #666);
      margin-top: 4px;
      font-style: italic;
    }
  </style>
</head>
<body>
  <h1>CalDAV Sync Settings</h1>

  <form id="settingsForm">
    <div class="form-group">
      <label for="calendarUrl">CalDAV Calendar URL *</label>
      <input
        type="url"
        id="calendarUrl"
        placeholder="https://nextcloud.example.com/remote.php/dav/calendars/user/calendar/"
        required
      >
      <div class="hint">Must end with /! Example: https://cloud.com/remote.php/dav/calendars/username/calendar/</div>
    </div>

    <div class="form-group">
      <label for="username">Username *</label>
      <input
        type="text"
        id="username"
        placeholder="username@example.com"
        required
      >
    </div>

    <div class="form-group">
      <label for="password">Password / App Password *</label>
      <input
        type="password"
        id="password"
        placeholder="App-specific password"
        required
      >
      <div class="hint">For Nextcloud: Create an app password in the security settings</div>
    </div>

    <div class="form-group">
      <div class="checkbox-group">
        <input type="checkbox" id="enabled">
        <label for="enabled">Enable CalDAV Sync</label>
      </div>
    </div>

    <div class="form-group">
      <div class="checkbox-group">
        <input type="checkbox" id="deleteCompletedTasks">
        <label for="deleteCompletedTasks">Delete completed tasks from calendar</label>
      </div>
      <div class="hint">When enabled, completed tasks are automatically removed from the calendar</div>
    </div>

    <div class="button-group">
      <button type="submit" class="btn-primary">Save</button>
      <button type="button" class="btn-secondary" id="testBtn">Test Connection</button>
      <button type="button" class="btn-tertiary" id="cancelBtn">Cancel</button>
    </div>

    <div id="status" class="status"></div>
  </form>

  <script>
    async function loadSettings() {
      try {
        window.parent.postMessage({
          type: 'REQUEST_CONFIG',
          pluginId: 'caldav-sync'
        }, '*');

        const config = await new Promise((resolve) => {
          const handler = (event) => {
            if (event.data && event.data.type === 'CONFIG_RESPONSE') {
              window.removeEventListener('message', handler);
              resolve(event.data.config);
            }
          };
          window.addEventListener('message', handler);

          setTimeout(() => {
            window.removeEventListener('message', handler);
            resolve(null);
          }, 2000);
        });

        if (config && typeof config === 'object' && !Array.isArray(config)) {
          document.getElementById('calendarUrl').value = config.calendarUrl || '';
          document.getElementById('username').value = config.username || '';
          document.getElementById('password').value = config.password || '';
          document.getElementById('enabled').checked = config.enabled || false;
          document.getElementById('deleteCompletedTasks').checked = config.deleteCompletedTasks !== false;
          showStatus('Settings loaded', 'success');
        } else {
          showStatus('No saved settings found', 'info');
        }
      } catch (error) {
        console.error('[CalDAV Settings] Error loading:', error);
        showStatus('Error loading settings', 'error');
      }
    }

    async function saveSettings(event) {
      event.preventDefault();

      const calendarUrl = document.getElementById('calendarUrl').value.trim();
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      const enabled = document.getElementById('enabled').checked;
      const deleteCompletedTasks = document.getElementById('deleteCompletedTasks').checked;

      if (!calendarUrl || !username || !password) {
        showStatus('Please fill out all required fields', 'error');
        return;
      }

      if (!calendarUrl.startsWith('http://') && !calendarUrl.startsWith('https://')) {
        showStatus('URL must start with http:// or https://', 'error');
        return;
      }

      if (!calendarUrl.endsWith('/')) {
        showStatus('Warning: URL should end with /!', 'error');
        return;
      }

      const config = { calendarUrl, username, password, enabled, deleteCompletedTasks };

      try {
        window.parent.postMessage({
          type: 'SAVE_CONFIG',
          pluginId: 'caldav-sync',
          config: config
        }, '*');

        const success = await new Promise((resolve) => {
          const handler = (event) => {
            if (event.data && event.data.type === 'CONFIG_SAVED') {
              window.removeEventListener('message', handler);
              resolve(event.data.success);
            }
          };
          window.addEventListener('message', handler);

          setTimeout(() => {
            window.removeEventListener('message', handler);
            resolve(false);
          }, 3000);
        });

        if (success) {
          await PluginAPI.showSnack({
            msg: 'Settings successfully saved',
            type: 'SUCCESS'
          });

          showStatus('Settings have been saved!', 'success');

          setTimeout(() => loadSettings(), 500);
        } else {
          throw new Error('Timeout while saving');
        }
      } catch (error) {
        console.error('[CalDAV Settings] Error saving:', error);
        showStatus('Error saving: ' + error.message, 'error');

        await PluginAPI.showSnack({
          msg: 'Error saving settings',
          type: 'ERROR'
        });
      }
    }

    async function testConnection() {
      const calendarUrl = document.getElementById('calendarUrl').value.trim();
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;

      if (!calendarUrl || !username || !password) {
        showStatus('Please fill out all fields first', 'error');
        return;
      }

      showStatus('Testing connection...', 'info');

      try {
        const response = await fetch(calendarUrl, {
          method: 'PROPFIND',
          headers: {
            'Authorization': 'Basic ' + btoa(username + ':' + password),
            'Depth': '0',
            'Content-Type': 'application/xml'
          }
        });

        if (response.ok || response.status === 207) {
          showStatus('✓ Connection successful! Server responds.', 'success');
          await PluginAPI.showSnack({
            msg: 'CalDAV connection successful',
            type: 'SUCCESS'
          });
        } else if (response.status === 401 || response.status === 403) {
          showStatus('✗ Authentication failed. Check username/password.', 'error');
        } else if (response.status === 404) {
          showStatus('✗ Calendar not found. Check the URL.', 'error');
        } else {
          showStatus(`✗ Error ${response.status}: ${response.statusText}`, 'error');
        }
      } catch (error) {
        console.error('[CalDAV Settings] Test error:', error);
        showStatus('✗ Connection error: ' + error.message, 'error');
      }
    }

    // Show status message
    function showStatus(message, type) {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      statusEl.className = 'status show ' + type;
    }

    document.getElementById('settingsForm').addEventListener('submit', saveSettings);
    document.getElementById('testBtn').addEventListener('click', testConnection);
    document.getElementById('cancelBtn').addEventListener('click', () => {
      loadSettings();
      showStatus('', '');
    });

    if (typeof PluginAPI !== 'undefined') {
      loadSettings();
    } else {
      showStatus('Error: Plugin API not loaded', 'error');
      setTimeout(() => {
        if (typeof PluginAPI !== 'undefined') {
          loadSettings();
        } else {
          console.error('[CalDAV Settings] PluginAPI not available');
        }
      }, 500);
    }
  </script>
</body>
</html>
