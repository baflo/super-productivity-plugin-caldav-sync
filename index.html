<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CalDAV Sync Einstellungen</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      padding: 24px;
      background: var(--theme-background, #f5f5f5);
      color: var(--theme-text, #333);
      line-height: 1.6;
    }

    h1 {
      font-size: 24px;
      margin-bottom: 24px;
      color: var(--theme-primary, #2196F3);
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      font-size: 14px;
      color: var(--theme-text, #333);
    }

    input[type="text"],
    input[type="password"],
    input[type="url"] {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--theme-border, #ddd);
      border-radius: 4px;
      font-size: 14px;
      background: var(--theme-input-background, #fff);
      color: var(--theme-text, #333);
      transition: border-color 0.2s;
    }

    input[type="text"]:focus,
    input[type="password"]:focus,
    input[type="url"]:focus {
      outline: none;
      border-color: var(--theme-primary, #2196F3);
    }

    input::placeholder {
      color: var(--theme-text-secondary, #999);
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .checkbox-group label {
      margin: 0;
      font-weight: normal;
      cursor: pointer;
    }

    .button-group {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    button:active {
      transform: translateY(0);
    }

    .btn-primary {
      background: #4CAF50;
      color: white;
    }

    .btn-primary:hover {
      background: #45a049;
    }

    .btn-secondary {
      background: #2196F3;
      color: white;
    }

    .btn-secondary:hover {
      background: #0b7dda;
    }

    .btn-tertiary {
      background: var(--theme-border, #ddd);
      color: var(--theme-text, #333);
    }

    .btn-tertiary:hover {
      background: var(--theme-border-dark, #ccc);
    }

    .status {
      margin-top: 16px;
      padding: 12px;
      border-radius: 4px;
      font-size: 14px;
      display: none;
    }

    .status.show {
      display: block;
    }

    .status.success {
      background: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #81c784;
    }

    .status.error {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #e57373;
    }

    .status.info {
      background: #e3f2fd;
      color: #1565c0;
      border: 1px solid #64b5f6;
    }

    .hint {
      font-size: 12px;
      color: var(--theme-text-secondary, #666);
      margin-top: 4px;
      font-style: italic;
    }
  </style>
</head>
<body>
  <h1>CalDAV Sync Einstellungen</h1>

  <form id="settingsForm">
    <div class="form-group">
      <label for="calendarUrl">CalDAV Kalender URL *</label>
      <input
        type="url"
        id="calendarUrl"
        placeholder="https://nextcloud.example.com/remote.php/dav/calendars/user/calendar/"
        required
      >
      <div class="hint">Muss mit / enden! Beispiel: https://cloud.com/remote.php/dav/calendars/username/calendar/</div>
    </div>

    <div class="form-group">
      <label for="username">Benutzername *</label>
      <input
        type="text"
        id="username"
        placeholder="username@example.com"
        required
      >
    </div>

    <div class="form-group">
      <label for="password">Passwort / App-Password *</label>
      <input
        type="password"
        id="password"
        placeholder="App-spezifisches Passwort"
        required
      >
      <div class="hint">Für Nextcloud: Erstelle ein App-Passwort in den Sicherheitseinstellungen</div>
    </div>

    <div class="form-group">
      <div class="checkbox-group">
        <input type="checkbox" id="enabled">
        <label for="enabled">CalDAV Sync aktivieren</label>
      </div>
    </div>

    <div class="button-group">
      <button type="submit" class="btn-primary">Speichern</button>
      <button type="button" class="btn-secondary" id="testBtn">Verbindung testen</button>
      <button type="button" class="btn-tertiary" id="cancelBtn">Abbrechen</button>
    </div>

    <div id="status" class="status"></div>
  </form>

  <script>
    // Settings beim Laden der Seite laden
    async function loadSettings() {
      try {
        console.log('[CalDAV Settings] Lade Config...');

        // WORKAROUND: loadSyncedData im iframe gibt KEY statt VALUE zurück (Super Productivity Bug)
        // Nutze stattdessen postMessage an plugin.js
        window.parent.postMessage({
          type: 'REQUEST_CONFIG',
          pluginId: 'caldav-sync'
        }, '*');

        // Warte auf Antwort vom plugin.js
        const config = await new Promise((resolve) => {
          const handler = (event) => {
            if (event.data && event.data.type === 'CONFIG_RESPONSE') {
              window.removeEventListener('message', handler);
              resolve(event.data.config);
            }
          };
          window.addEventListener('message', handler);

          // Timeout nach 2 Sekunden
          setTimeout(() => {
            window.removeEventListener('message', handler);
            resolve(null);
          }, 2000);
        });

        console.log('[CalDAV Settings] Geladene Config:', config);
        console.log('[CalDAV Settings] Config Typ:', typeof config);

        if (config && typeof config === 'object' && !Array.isArray(config)) {
          console.log('[CalDAV Settings] Config ist valide, setze Formular-Felder...');
          document.getElementById('calendarUrl').value = config.calendarUrl || '';
          document.getElementById('username').value = config.username || '';
          document.getElementById('password').value = config.password || '';
          document.getElementById('enabled').checked = config.enabled || false;
          console.log('[CalDAV Settings] Formular-Felder gesetzt');
          showStatus('Einstellungen geladen', 'success');
        } else {
          console.log('[CalDAV Settings] Config ist nicht valide oder leer');
          showStatus('Keine gespeicherten Einstellungen gefunden', 'info');
        }
      } catch (error) {
        console.error('[CalDAV Settings] Fehler beim Laden:', error);
        showStatus('Fehler beim Laden der Einstellungen', 'error');
      }
    }

    // Settings speichern
    async function saveSettings(event) {
      event.preventDefault();

      const calendarUrl = document.getElementById('calendarUrl').value.trim();
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      const enabled = document.getElementById('enabled').checked;

      // Validierung
      if (!calendarUrl || !username || !password) {
        showStatus('Bitte alle Pflichtfelder ausfüllen', 'error');
        return;
      }

      if (!calendarUrl.startsWith('http://') && !calendarUrl.startsWith('https://')) {
        showStatus('URL muss mit http:// oder https:// beginnen', 'error');
        return;
      }

      if (!calendarUrl.endsWith('/')) {
        showStatus('Warnung: URL sollte mit / enden!', 'error');
        return;
      }

      const config = {
        calendarUrl,
        username,
        password,
        enabled
      };

      try {
        console.log('[CalDAV Settings] Speichere Config:', { ...config, password: '***' });

        // WORKAROUND: Sende Config an plugin.js zum Speichern
        window.parent.postMessage({
          type: 'SAVE_CONFIG',
          pluginId: 'caldav-sync',
          config: config
        }, '*');

        // Warte auf Bestätigung
        const success = await new Promise((resolve) => {
          const handler = (event) => {
            if (event.data && event.data.type === 'CONFIG_SAVED') {
              window.removeEventListener('message', handler);
              resolve(event.data.success);
            }
          };
          window.addEventListener('message', handler);

          setTimeout(() => {
            window.removeEventListener('message', handler);
            resolve(false);
          }, 3000);
        });

        if (success) {
          console.log('[CalDAV Settings] Config erfolgreich gespeichert');

          await PluginAPI.showSnack({
            msg: 'Einstellungen erfolgreich gespeichert',
            type: 'SUCCESS'
          });

          showStatus('Einstellungen wurden gespeichert!', 'success');

          // Formular neu laden um gespeicherte Werte anzuzeigen
          setTimeout(() => {
            loadSettings();
          }, 500);
        } else {
          throw new Error('Timeout beim Speichern');
        }
      } catch (error) {
        console.error('[CalDAV Settings] Fehler beim Speichern:', error);
        showStatus('Fehler beim Speichern: ' + error.message, 'error');

        await PluginAPI.showSnack({
          msg: 'Fehler beim Speichern der Einstellungen',
          type: 'ERROR'
        });
      }
    }

    // Verbindung testen
    async function testConnection() {
      const calendarUrl = document.getElementById('calendarUrl').value.trim();
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;

      if (!calendarUrl || !username || !password) {
        showStatus('Bitte erst alle Felder ausfüllen', 'error');
        return;
      }

      showStatus('Teste Verbindung...', 'info');

      try {
        // PROPFIND Request zum Testen
        const response = await fetch(calendarUrl, {
          method: 'PROPFIND',
          headers: {
            'Authorization': 'Basic ' + btoa(username + ':' + password),
            'Depth': '0',
            'Content-Type': 'application/xml'
          }
        });

        console.log('[CalDAV Settings] Test Response:', response.status, response.statusText);

        if (response.ok || response.status === 207) {
          showStatus('✓ Verbindung erfolgreich! Server antwortet.', 'success');

          await PluginAPI.showSnack({
            msg: 'CalDAV Verbindung erfolgreich',
            type: 'SUCCESS'
          });
        } else if (response.status === 401 || response.status === 403) {
          showStatus('✗ Authentifizierung fehlgeschlagen. Prüfe Benutzername/Passwort.', 'error');
        } else if (response.status === 404) {
          showStatus('✗ Kalender nicht gefunden. Prüfe die URL.', 'error');
        } else {
          showStatus(`✗ Fehler ${response.status}: ${response.statusText}`, 'error');
        }
      } catch (error) {
        console.error('[CalDAV Settings] Test Fehler:', error);
        showStatus('✗ Verbindungsfehler: ' + error.message, 'error');
      }
    }

    // Status-Nachricht anzeigen
    function showStatus(message, type) {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      statusEl.className = 'status show ' + type;
    }

    // Event Listeners
    document.getElementById('settingsForm').addEventListener('submit', saveSettings);
    document.getElementById('testBtn').addEventListener('click', testConnection);
    document.getElementById('cancelBtn').addEventListener('click', () => {
      loadSettings(); // Reset form
      showStatus('', '');
    });

    // Initial load - warte auf PluginAPI
    if (typeof PluginAPI !== 'undefined') {
      console.log('[CalDAV Settings] PluginAPI verfügbar, lade Settings...');
      loadSettings();
    } else {
      console.error('[CalDAV Settings] PluginAPI nicht verfügbar!');
      showStatus('Fehler: Plugin API nicht geladen', 'error');

      // Versuche es nach kurzer Verzögerung nochmal
      setTimeout(() => {
        if (typeof PluginAPI !== 'undefined') {
          console.log('[CalDAV Settings] PluginAPI jetzt verfügbar, lade Settings...');
          loadSettings();
        } else {
          console.error('[CalDAV Settings] PluginAPI immer noch nicht verfügbar');
        }
      }, 500);
    }
  </script>
</body>
</html>
